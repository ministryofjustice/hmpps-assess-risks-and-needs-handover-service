# hmpps-assess-risks-and-needs-handover-service
[![repo standards badge](https://img.shields.io/endpoint?labelColor=231f20&color=005ea5&style=flat&logo=data:image/png;base64,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&label=MoJ%20Compliant&url=https%3A%2F%2Foperations-engineering-reports.cloud-platform.service.justice.gov.uk%2Fapi%2Fv1%2Fcompliant_public_repositories%2Fendpoint%2Fhmpps-assess-risks-and-needs-handover-service)](https://operations-engineering-reports.cloud-platform.service.justice.gov.uk/public-report/hmpps-assess-risks-and-needs-handover-service "Link to report")
[![CircleCI](https://circleci.com/gh/ministryofjustice/hmpps-assess-risks-and-needs-handover-service/tree/main.svg?style=svg)](https://circleci.com/gh/ministryofjustice/hmpps-assess-risks-and-needs-handover-service)
[![Docker Repository on Quay](https://quay.io/repository/hmpps/hmpps-assess-risks-and-needs-handover-service/status "Docker Repository on Quay")](https://quay.io/repository/hmpps/hmpps-assess-risks-and-needs-handover-service)
[![API docs](https://img.shields.io/badge/API_docs_-view-85EA2D.svg?logo=swagger)](http://arns-handover-service-dev.hmpps.service.justice.gov.uk/swagger-ui/index.html)

HMPPS Assess Risks and Needs (ARNS) Handover Service is a (mostly) backend service built for handling authentication 
and shared context data across OASys and ARNS-space applications. It is managed by both the ARNS and 
Sentence Planning (SP) team as both os their projects rely on it for authentication.

## What is the handover service? How does it work?

The ARNS Handover Service operates as follows:

1. **Handover Context Payload**: 
   - A client (OASys) authorized through HMPPS Auth sends a payload of contextual data to the `/handover` endpoint in the ARNS. 
   Handover Service. This payload includes information about the principal, the subject, and additional context related to 
   HMPPS Strength-Based Needs Assessment (SBNA/SAN) or HMPPS Sentence Plan (SP).

2. **Handover Link Generation**: 
   - A handover link is generated and returned to the client. This link should be presented to the user.

3. **User Authentication**: 
   - When the user clicks on the handover link, they are authenticated within the ARNS Handover Service. A cookie
   is stored on the user's browser to maintain this authentication session.

4. **Redirection to Intended Service**:
   - The ARNS Handover Service then redirects the user to the intended service (SBNA/SAN or SP).

5. **OAuth2 Authorization**: 
   - The intended service initiates an OAuth2 authorization code flow grant with the user and the ARNS Handover Service.
   Note that intended service must have a registered client within the ARNS Handover Service, and therefore know the
   client ID and client secret to perform this flow.

6. **Access Token Retrieval**: 
   - After the authorization code flow is completed, the intended service receives an access token for the user.

7. **Contextual Data Exchange**: 
   - The intended service can then use the access token to exchange for the contextual information provided in step 1.

## Running the service

To run this service in your local environment, follow these steps:

1. **Set the Active Spring Profile to `local`**
    - The `local` profile configures various application properties, enabling the ARNS Handover Service to work 
      with a client service hosted at `localhost:3000`.

2. **Run a Redis Instance**
    - Ensure a passwordless Redis instance is running on `localhost:6379`.

## Generating a handover session
Currently, the ARNS Handover Service does not provide a user interface for generating handover sessions and 
their subsequent handover links. Instead, a cURL request can be made to the `/handover` endpoint to create a session.

```cURL
curl -X "POST" "http://localhost:8080/handover" \
     -H 'Authorization: Bearer HMPPS_AUTH_CLIENT_CREDENTIALS_JWT \
     -H 'Content-Type: application/json; charset=utf-8' \
     -d $'{
  "subject": {
    "gender": 0,
    "location": 0,
    "crn": "X483319",
    "sexuallyMotivatedOffenceHistory": true,
    "dateOfBirth": "1990-01-01",
    "familyName": "John",
    "givenName": "Smith",
    "pnc": "01/1000000"
  },
  "assessmentContext": {
    "oasysAssessmentPk": "913ea2fc-049f-41c6-a19e-be2e8725712b",
    "assessmentUUID": "d8cb7e78-1d55-4153-a2ed-a73fefc361a8"
  },
  "principal": {
    "displayName": "Jane Doe",
    "accessMode": "READ_WRITE",
    "identifier": "123ABC"
  }
}'
```

This request will return an object formatted like

```json
{
   "handoverSessionId": "{HANDOVER_SESSION_UUID}",
   "handoverLink": "http://localhost:8080/handover/{HANDOVER_CODE}"
}
```
where the value of property `handoverLink` will be a URL that can be used within the browser to begin the handover
process.

## Connecting to a remote Redis instance in dev/preprod/prod

1. Switch to the Kubernetes context/namespace of the Redis instance you are connecting to
2. `make redis-port-forward-pod` to create a Redis port-forwarding pod in the namespace
3. `make redis-port-forward` to forward traffic from your machine to the pod

Then open a new terminal and either:

`make redis-connect` to connect to the remote Redis instance on the command line

or

`make redis-auth-token` to output an authentication token for connecting to Redis via your Database IDE
